<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <style type="text/css"><!--
	.code {
	  border: 2px dotted;

	  font-family: Courier,monospace;
	  font-size: 90%;

	  background-color: #E0E0E0;
	  margin-left: 10;
	  margin-right: 10;
	  padding-left: 10;
	  padding-right: 10;
	  padding-top: 0;
	  padding-bottom: 10;
	}
    a { text-decoration: none; color: #0000cc }
    a:hover { text-decoration: underline; color: #0000cc; }
  --></style>
<title>Spyce - Python Server Pages (PSP)</title>
  <meta NAME="LANGUAGE" CONTENT="en-US">
  <meta NAME="RATING" CONTENT="GENERAL">
  <meta NAME="ROBOTS" CONTENT="ALL">
  <meta name="abstract" content="Spyce is a server-side language that supports simple and efficient Python-based dynamic HTML generation. Those who like Python and are familiar with JSP, or PHP, or ASP, should have a look at Spyce.">
  <meta name="description" content="Spyce - Python Server Pages: a server-side language that supports simple and efficient Python-based dynamic HTML generation.">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta HTTP-EQUIV="Refresh" CONTENT="1800">
  <meta HTTP-EQUIV="Revisit-After" CONTENT="15 days">
  <link rel="icon" href="spycefav.ico" type="image/x-icon">
  <link rel="shortcut icon" href="spycefav.ico" type="image/x-icon">
<link rel="Next" href="doc-None.html">
<link rel="next" href="doc-None.html">
<link rel="Previous" href="doc-None.html">
<link rel="Prev" href="doc-None.html">
<link rel="prev" href="doc-None.html">
<link rel="Contents" href="doc.html">
<link rel="contents" href="doc.html">
</head>

<body bgcolor="#efefef">

<table border=0 cellspacing=0 cellpadding=0 width="100%"><tr><td valign=top>

<!-- links section -->

<!-- index -->
<table border=0 align=center width="100%"><tr><td align=center nowrap>
  <a href="http://spyce.sourceforge.net"><img src="/spyce.gif" border=0 alt="spyce" width=58 height=70></a>
</td></tr></table>

<table align=center border=1 cellpadding=4 cellspacing=0 bgcolor="#CCCCCC">
<tr><td align=left bgColor="#AAAAAA"><b>
  <font face="arial, helvetica" size="-1">
<b><a href="/index.html">home</a></b><br>
  </font>
</b></td></tr>
<tr><td align=left>
  <font face="arial, helvetica" size="-1">
<b><a href="http://svn-hosting.com/svn/spyce/trunk/spyce/CHANGES">changelog</a></b><br>
<b><a href="/docs/license.html">license</a></b><br>
<b><a href="/docs/get.html">download</a></b><br>
<b><a href="/docs/mail.html">community</a></b><br>
<b><a href="/docs/wishlist.html">wishlist</a></b><br>
  </font>
</td></tr>
<tr><td align=left bgColor="#AAAAAA"><b>
  <font face="arial, helvetica" size="-1">
<b><a href="/docs/doc.html">documentation</a></b><br>
  </font>
</b></td></tr>
<tr><td align=left>
  <font face="arial, helvetica" size="-1">
<b><a href="/docs/doc-intro.html">intro</a></b><br>
<b><a href="/docs/doc-lang.html">language</a></b><br>
<b><a href="/docs/doc-runtime.html">runtime</a></b><br>
<b><a href="/docs/doc-mod.html">modules</a></b><br>
<b><a href="/docs/doc-tag.html">tags</a></b><br>
<b><a href="/docs/doc-conf.html">install</a></b><br>
<b><a href="/docs/eg.html">examples list</a></b><br>
  </font>
</td></tr>
<tr><td align=left bgColor="#AAAAAA"><b>
  <font face="arial, helvetica" size="-1">
      <b>other</b>
  </font>
</b></td></tr>
<tr><td align=left>
  <font face="arial, helvetica" size="-1">
<b><a href="/docs/links.html">resources</a></b><br>
<b><a href="http://sourceforge.net/projects/spyce/">sf project</a></b><br>
<b><a href="http://spyced.blogspot.com/">spyced blog</a></b><br>
  </font>
</td></tr></table><br>

<!-- spacers -->
</td>
<td width=15><img src=/trans1x1.gif width=15 height=1 ></td>
<td width=1 bgcolor="#888888"><img src=/trans1x1.gif width=1 height=1 ></td>
<td width=15><img src=/trans1x1.gif width=15 height=1 ></td>
<td width="100%" valign=top>

<!-- page title -->
<table border=0 width="100%"><tr>
  <td nowrap valign=bottom>
    <b><font face="arial, helvetica" size="-1"><big>Documentation</big></font></b><br clear=all>
  </td>
  <td align=right nowrap valign=bottom>
    <font face="arial, helvetica" size="-1">
    <b><big>[[ <font face="arial, helvetica" color="#cc0000">Spyce</font> ]]</big></b><br>
    </font>
</tr></table>

<hr>
<font face="arial, helvetica" size="-1">

<!-- body -->

<table width="100%" align=center><tr>
    <td align=left width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Prev:</b> None</font></td>
    <td align=center width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Up:</b> None</font></td>
    <td align=right width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Next:</b> None</font></td>
</tr></table>
<hr>
<big><a name="mod_session"></a><b>4.11. <font color=#ee0000>Session</font></b></big><p>


Sessions allow information to be efficiently passed from one request to the
next via some browser mechanism: get, post or cookie. The potentially large or
sensitive information is stored at the server, and only a short identifier is
sent to the client. Sessions are often used to create sequences of pages that
represent an application flow. This module manages session state. All session
state has an expiration time and is automatically garbage collected.
<ul>
<li><b>setHandler</b>( type, [ params ] ): <br> Selects the session handler.
This method must be called before invoking other session functions. The
<b>type</b> specifies the handler, and the <b>param(s)</b> is (are) passed
to the initialiser of the chosen handler. The type parameter is a string of
the format: <font face=courier>"file:class"</font>, where <b>file</b> is the
location where the session handler is defined and <b>class</b> is the name
of the session handler. The file name component is optional, and is searched
for using the standard module-finding rules. If only the class name is
specified, then the default location is used: inside the session module
itself, where the standard Spyce session handlers reside. <p>
The standard Spyce session handlers are listed below, along with the
parameters they take. If you would like to implement your own, custom
session handler, there are two ways to do so. First, you can have a look at
<font face=courier>modules/session.py</font> and define your subclass of the
<font face=courier>sessionHandler</font> class. One would do this when
defining a general-purpose session handler, and if you do go to this
trouble, please email it in as a <a
href="/contrib">contribution</a>.
Alternatively, you can simply use the <b>session_user</b> handler, also
defined below, to your own install callback functions. The majority of users
should be satisfied with the basic session handlers provided. <p>
<ul>
<li>setHandler( <b>'session_dir'</b>, directory ): <br> Uses inidividual
files in the specified <b>directory</b> to store session information.
If directory is not specified, tmp specified in spyceconf is used.
</li><p>
<li>setHandler( <b>'session_gdbm'</b>, file ): <br> Uses the gdbm library
to create and manage the session information inside the specified
<b>file</b>. </li><p>
<li>setHandler( <b>'session_bsddb'</b>, file ): <br> Uses the BSD database
library to create and manage the session information inside the specified
<b>file</b>. </li><p>
<li>setHandler( <b>'session_user'</b>, getf, setf, delf, idsf, info ):
<br> Uses user-provided functions to create and manage session
information. The parameters are as follows:
<ul>
<li><b>getf</b>: A function that will be called to get session state, as
follows: <font face=courier>getf(info,&nbsp;id)</font>, where
<b>info</b> is the parameter given to setHandler above, and <b>id</b> is
the session identifier. This function should ensure that the session has
not expired. If an expired session is found, it must be automatically
deleted. Note that a delete may never be called on an object, so it is
imperative for getf() to delete objects when expiration is detected. If
the session has expired, or if the session does not exist, this function
should return None, otherwise the session information. </li>
<li><b>setf</b>: A function that will be called to set or create session
state, as follows: <font
face=courier>setf(info,&nbsp;state,&nbsp;expire,&nbsp;serverID,&nbsp;id)</font>,
where <b>info</b> is the parameter given to setHandler above,
<b>state</b> is the actual session information to be preserved,
<b>expire</b> is the number of seconds after which this information will
be invalidated, <b>serverID</b> is a unique identifier for this server
that can be used to avoid race conditions between two Spyce engines
generating new session identifiers, and <b>id</b> is the optional
session identifier. If an identifier is provided, that session should be
updated, otherwise (namely, in the case when id is set to None), a new
session identifier should be generated. This function returns the (new
or old) session identifier. </li>
<li><b>delf</b>: A function that will be called to set delete a session,
as follows: <font face=courier>delf(info,&nbsp;id)</font>, where
<b>info</b> is the parameter given to the setHandler above and <b>id</b>
is the session identifier of the session to be invalidated. </li>
<li><b>idsf</b>: A function that will be called to get all the session
identifiers, as follows: <font face=courier>idsf(info)</font>, where
<b>info</b> is the parameter given to the setHandler above. This
function should return ALL session identifiers, even those that have
expired and are to be deleted. Among other purposes, this function is
used to automatically clean up session state periodically, by performing
a getf() on all sessions. (Remember that according to the semantics
defined for getf(), it will delete any expired sessions.) </li>
<li><b>info</b>: At the very least, this is a key that uniquely
identifies this session handler. The info variable may also contain any
other additional information. It is passed back as-is to each of the
session callback functions, as described previously. </li>
</ul> <p>
</ul>
<p>
<li><b>get</b>( id ): <br> Returns the object stored under the given
<b>id</b>. If the id does not exist, or was previously used but has expired,
then None is returned. As with the cookie module, the session module may be
treated as an associative array when retrieving session information.
</li><p>
<li><b>set</b>( data, expire, [id] ): <br> Stores the <b>data</b> object
under the given <b>id</b>. If id is omitted, then a unique one is generated.
On success, an id is returned, otherwise an exception raised. The
<b>expire</b> field specifies the number of seconds that the session
information is valid for. </li><p>
<li><b>delete</b>( id ): <br> Deletes the session stored under the given
<b>id</b>. Note that sessions are automatically deleted upon expiration, so
this method need only be used when immediate invalidation is desired. As
with the cookie module, the session module may be treated as an associative
array when removing session information. </li><p>
<li><b>autoSession</b>( expire, [method], [name] ): <br> This function can
remove most of the code associated with session management, by doing it
automatically. Namely, it automatically retrieves the session information
and resaves it at the end of the request, using the <b>auto</b>,
<b>autoID</b>, <b>autoName</b> and <b>autoMethod</b> fields (explained
below). The <b>expire</b> parameters acts as before, to specify how long the
session information remains valid. The <b>method</b> and <b>name</b>
parameters instruct the session module how to find the session identifier.
Method can be one of <font face=courier>'get'</font>, <font
face=courier>'post'</font>, or <font face=courier>'cookie'</font>, which is
the default. The name parameter, under which the session id is stored,
defaults to 'spyceSession'. If the lookup is unable to find a session id for
this request a new session is created. At the end of the request, the
session information is automatically saved, and a cookie automatically
generated if the 'cookie' method was chosen. For the 'get' and 'post'
methods the user is required to encode the <b>autoID</b> (session id) inside
all form targets and urls that are generated. </li><p>
<li><b>auto</b>: <br> The field containing the actual session information,
when automatic session management is used. Set it to whatever you like, as
long as it can be serialized. Its initial value, for a new session, is None.
</li><p>
<li><b>autoID</b>: <br> The session identifier, when automatiic session
management is used. </li><p>
<li><b>autoName</b>: <br> The variable named used to identify the cookie or
the parameter in the get or post requests containing the session identifier,
when automatic session management is used.</li><p>
<li><b>autoMethod</b>: <br> The method used ('cookie', 'post' or 'get') to
load and save the session identifier, when automatic session management is
used.</li><p>
</ul>
The example below shows how a session can be used to count the number of times
the same open browser visited our page. The session ID is stored in a cookie
that expires when the browser is closed. Note that the session module
automatically loads the cookie module if not already loaded and is needed.<p>

<table border=1 align=center>
<tr><td align=left bgcolor="#cccccc">
  <font face="arial, helvetica" size="-1"><b>examples/session.spy</b></font>
</td></tr><tr><td>
  <font face=courier>

    <pre><font color="#000000"><b><font color="#CC00CC">[[.import name=cookie]]</font>
<font color="#CC00CC">[[.import name=session args=&quot;'session_dir'&quot;]]</font>
&lt;html&gt;&lt;body&gt;
  <font color="#ff7448">[[-- retrieve session information --]]</font>
  <font color="#0000CC">[[\
    sessionid = cookie.get('session')
    if sessionid:
      num = session.get(sessionid)
      if num==None:
        sessionid = None
        num = 0
      else: num = int(num)
    else: num = 0
  ]]</font>
  <font color="#ff7448">[[-- output --]]</font>
  Your session ID was: <font color="#CC0000">[[=sessionid]]</font>&lt;br&gt;
  <font color="#0000CC">[[num = num + 1]]</font>
  You have visited this page <font color="#CC0000">[[=num]]</font> time(s).&lt;br&gt;
  <font color="#ff7448">[[-- save session information for next time --]]</font>
  <font color="#0000CC">[[\
    sessionid = session.set( num, 10, sessionid )
    if sessionid: cookie.set('session', sessionid)
  ]]</font>
  Your session ID is now: <font color="#CC0000">[[=sessionid]]</font>&lt;br&gt;
  Session expiration = 10 seconds.&lt;br&gt;
  &lt;b&gt;Note:&lt;/b&gt; This example requires write access to 
  the spyceconf tmp directory to function correctly.
&lt;/body&gt;&lt;/html&gt;
</b></font></pre>
  </font>

  </td></tr><tr><td align=right bgcolor="#cccccc">
    <font face="arial, helvetica" size="-1">
      
      <b><a href="examples/session.spy">Run this code</a></b>
    </font>

</td></tr></table>
<p>
The next example highlights the convenience of using autoSession. By default,
the session identifier is stored using a cookie named 'spyceSession'.<p>

<table border=1 align=center>
<tr><td align=left bgcolor="#cccccc">
  <font face="arial, helvetica" size="-1"><b>examples/autosession.spy</b></font>
</td></tr><tr><td>
  <font face=courier>

    <pre><font color="#000000"><b><font color="#CC00CC">[[.import name=session args=&quot;'session_dir', auto=10&quot;]]</font>
&lt;html&gt;&lt;body&gt;
  <font color="#ff7448">[[-- count visits --]]</font>
  <font color="#0000CC">[[\ 
    if not session.auto: session.auto = 1
    else: session.auto = session.auto + 1
  ]]</font>
  <font color="#ff7448">[[-- output --]]</font>
  You have visited this page <font color="#CC0000">[[=session.auto]]</font> time(s)&lt;br&gt;
  Your autosession ID is: <font color="#CC0000">[[=session.autoID]]</font>&lt;br&gt;
  Autosession expiration = 10 seconds.&lt;br&gt;
  &lt;b&gt;Note:&lt;/b&gt; This example requires write access to 
  the spyceconf tmp directory to function correctly.
&lt;/body&gt;&lt;/html&gt;
</b></font></pre>
  </font>

  </td></tr><tr><td align=right bgcolor="#cccccc">
    <font face="arial, helvetica" size="-1">
      
      <b><a href="examples/autosession.spy">Run this code</a></b>
    </font>

</td></tr></table>
<p>
If cookies are not desired, the automatic session identifier
<font face=courier>session.autoID</font> can also be transmitted via a browser
post, as shown:<p>

<table border=1 align=center>
<tr><td align=left bgcolor="#cccccc">
  <font face="arial, helvetica" size="-1"><b>examples/autosessionpost.spy</b></font>
</td></tr><tr><td>
  <font face=courier>

    <pre><font color="#000000"><b><font color="#CC00CC">[[.import name=session args=&quot;'session_dir', auto=(10,'post','mysession')&quot;]]</font>
&lt;html&gt;&lt;body&gt;
  <font color="#ff7448">[[-- count visits --]]</font>
  <font color="#0000CC">[[\
    if not session.auto: session.auto = 1
    else: session.auto = session.auto + 1
  ]]</font>
  <font color="#ff7448">[[-- output --]]</font>
  You have visited this page <font color="#CC0000">[[=session.auto]]</font> time(s)&lt;br&gt;
  Your autosession ID is: <font color="#CC0000">[[=session.autoID]]</font>&lt;br&gt;
  Autosession expiration = 10 seconds.&lt;br&gt;
  &lt;table&gt;&lt;tr&gt;
    &lt;td&gt;
      &lt;form method=post&gt;
        &lt;input type=submit value=Refresh&gt;
        &lt;input type=hidden name=mysession value=<font color="#CC0000">[[=session.autoID]]</font>&gt;
      &lt;/form&gt;
      &lt;/td&gt;&lt;td&gt;
      &lt;form method=post&gt;
        &lt;input type=submit value=Clear&gt;
      &lt;/form&gt;
    &lt;/td&gt;
  &lt;/tr&gt;&lt;/table&gt;&lt;br&gt;
  &lt;b&gt;Note:&lt;/b&gt; This example requires write access to 
  the spyceconf tmp directory to function correctly.
&lt;/body&gt;&lt;/html&gt;
</b></font></pre>
  </font>

  </td></tr><tr><td align=right bgcolor="#cccccc">
    <font face="arial, helvetica" size="-1">
      
      <b><a href="examples/autosessionpost.spy">Run this code</a></b>
    </font>

</td></tr></table>
 <p>
Finally, one can easily define some new session handling mechanism using
callback functions, as this last example shows:

<table border=1 align=center>
<tr><td align=left bgcolor="#cccccc">
  <font face="arial, helvetica" size="-1"><b>examples/mysession.spy</b></font>
</td></tr><tr><td>
  <font face=courier>

    <pre><font color="#000000"><b><font color="#CC00CC">[[.import names=&quot;pool,session&quot;]]</font>
<font color="#0000CC">[[\
  # storing session info as server pool variable,
  # so that example is portable! -- you'll 
  # want to have some persistent DB connection.
  if not pool.has_key('mysession'):
    pool['mysession'] = {}
    pool['mysessioncount'] = 1
  def myget(info, id):
    import time
    try:
      state, expiretime = pool['mysession'][id]
      if int(time.time()) &gt; expiretime:
        del pool['mysession'][id]
        return None
      return state
    except KeyError:
      return None
  def myset(info, state, expire, serverID, id):
    import time
    if not id:
      # lock here if running threaded engine
      id = str(pool['mysessioncount'])
      pool['mysessioncount'] = pool['mysessioncount'] + 1
    pool['mysession'][id] = state, int(time.time())+expire
    return id
  def mydel(info, id):
    try: del pool['mysession'][id]
    except KeyError: pass
  def myids(info):
    return pool['mysession'].keys()
  session.setHandler('session_user', myget, myset, mydel, myids, 'mysession')
  session.autoSession(10)
]]</font>
&lt;html&gt;&lt;body&gt;
  <font color="#ff7448">[[-- count visits --]]</font>
  <font color="#0000CC">[[\ 
    if not session.auto: session.auto = 1
    else: session.auto = session.auto + 1
  ]]</font>
  <font color="#ff7448">[[-- output --]]</font>
  You have visited this page <font color="#CC0000">[[=session.auto]]</font> time(s)&lt;br&gt;
  Your autosession ID is: <font color="#CC0000">[[=session.autoID]]</font>&lt;br&gt;
  Autosession expiration = 10 seconds.&lt;br&gt;
&lt;/body&gt;&lt;/html&gt;
</b></font></pre>
  </font>

  </td></tr><tr><td align=right bgcolor="#cccccc">
    <font face="arial, helvetica" size="-1">
      
      <b><a href="examples/mysession.spy">Run this code</a></b>
    </font>

</td></tr></table>
 <p>
<hr>

<table width="100%" align=center><tr>
    <td align=left width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Prev:</b> None</font></td>
    <td align=center width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Up:</b> None</font></td>
    <td align=right width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Next:</b> None</font></td>
</tr></table>
<!-- end body -->
<p>
</font>
</td></tr>
<tr><td colspan=5><hr></td></tr>
<tr><td colspan=5 height=15></td></tr>
<tr><td colspan=5>

  <table width="100%" border=0><tr>
    <td align=left valign=top>
      <font face="arial, helvetica" size="-1">
      <b><big>[[ <font face="arial, helvetica" color="#cc0000">Spyce</font> ]]</big></b><br>
      <small>Python Server Pages<br>version 2.0.3</small>
      </font>
    </td><td align=center valign=top>
      <a href="http://spyce.sourceforge.net"><img align=middle width=120 height=50 border=0 src="/spycepow.gif" alt="Spyce Powered"></a>
      <a href="http://sourceforge.net"><img align=middle src="http://sourceforge.net/sflogo.php?group_id=53655&amp;type=5" width="141" height="50" border="0" alt="SourceForge Logo"></a>
    </td><td align=right valign=top>
    </td>
  </tr></table>

</td></tr></table>

</body></html>
