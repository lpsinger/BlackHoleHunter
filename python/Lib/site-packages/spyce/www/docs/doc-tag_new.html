<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <style type="text/css"><!--
	.code {
	  border: 2px dotted;

	  font-family: Courier,monospace;
	  font-size: 90%;

	  background-color: #E0E0E0;
	  margin-left: 10;
	  margin-right: 10;
	  padding-left: 10;
	  padding-right: 10;
	  padding-top: 0;
	  padding-bottom: 10;
	}
    a { text-decoration: none; color: #0000cc }
    a:hover { text-decoration: underline; color: #0000cc; }
  --></style>
<title>Spyce - Python Server Pages (PSP)</title>
  <meta NAME="LANGUAGE" CONTENT="en-US">
  <meta NAME="RATING" CONTENT="GENERAL">
  <meta NAME="ROBOTS" CONTENT="ALL">
  <meta name="abstract" content="Spyce is a server-side language that supports simple and efficient Python-based dynamic HTML generation. Those who like Python and are familiar with JSP, or PHP, or ASP, should have a look at Spyce.">
  <meta name="description" content="Spyce - Python Server Pages: a server-side language that supports simple and efficient Python-based dynamic HTML generation.">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta HTTP-EQUIV="Refresh" CONTENT="1800">
  <meta HTTP-EQUIV="Revisit-After" CONTENT="15 days">
  <link rel="icon" href="spycefav.ico" type="image/x-icon">
  <link rel="shortcut icon" href="spycefav.ico" type="image/x-icon">
<link rel="Next" href="doc-None.html">
<link rel="next" href="doc-None.html">
<link rel="Previous" href="doc-None.html">
<link rel="Prev" href="doc-None.html">
<link rel="prev" href="doc-None.html">
<link rel="Contents" href="doc.html">
<link rel="contents" href="doc.html">
</head>

<body bgcolor="#efefef">

<table border=0 cellspacing=0 cellpadding=0 width="100%"><tr><td valign=top>

<!-- links section -->

<!-- index -->
<table border=0 align=center width="100%"><tr><td align=center nowrap>
  <a href="http://spyce.sourceforge.net"><img src="/spyce.gif" border=0 alt="spyce" width=58 height=70></a>
</td></tr></table>

<table align=center border=1 cellpadding=4 cellspacing=0 bgcolor="#CCCCCC">
<tr><td align=left bgColor="#AAAAAA"><b>
  <font face="arial, helvetica" size="-1">
<b><a href="/index.html">home</a></b><br>
  </font>
</b></td></tr>
<tr><td align=left>
  <font face="arial, helvetica" size="-1">
<b><a href="http://svn-hosting.com/svn/spyce/trunk/spyce/CHANGES">changelog</a></b><br>
<b><a href="/docs/license.html">license</a></b><br>
<b><a href="/docs/get.html">download</a></b><br>
<b><a href="/docs/mail.html">community</a></b><br>
<b><a href="/docs/wishlist.html">wishlist</a></b><br>
  </font>
</td></tr>
<tr><td align=left bgColor="#AAAAAA"><b>
  <font face="arial, helvetica" size="-1">
<b><a href="/docs/doc.html">documentation</a></b><br>
  </font>
</b></td></tr>
<tr><td align=left>
  <font face="arial, helvetica" size="-1">
<b><a href="/docs/doc-intro.html">intro</a></b><br>
<b><a href="/docs/doc-lang.html">language</a></b><br>
<b><a href="/docs/doc-runtime.html">runtime</a></b><br>
<b><a href="/docs/doc-mod.html">modules</a></b><br>
<b><a href="/docs/doc-tag.html">tags</a></b><br>
<b><a href="/docs/doc-conf.html">install</a></b><br>
<b><a href="/docs/eg.html">examples list</a></b><br>
  </font>
</td></tr>
<tr><td align=left bgColor="#AAAAAA"><b>
  <font face="arial, helvetica" size="-1">
      <b>other</b>
  </font>
</b></td></tr>
<tr><td align=left>
  <font face="arial, helvetica" size="-1">
<b><a href="/docs/links.html">resources</a></b><br>
<b><a href="http://sourceforge.net/projects/spyce/">sf project</a></b><br>
<b><a href="http://spyced.blogspot.com/">spyced blog</a></b><br>
  </font>
</td></tr></table><br>

<!-- spacers -->
</td>
<td width=15><img src=/trans1x1.gif width=15 height=1 ></td>
<td width=1 bgcolor="#888888"><img src=/trans1x1.gif width=1 height=1 ></td>
<td width=15><img src=/trans1x1.gif width=15 height=1 ></td>
<td width="100%" valign=top>

<!-- page title -->
<table border=0 width="100%"><tr>
  <td nowrap valign=bottom>
    <b><font face="arial, helvetica" size="-1"><big>Documentation</big></font></b><br clear=all>
  </td>
  <td align=right nowrap valign=bottom>
    <font face="arial, helvetica" size="-1">
    <b><big>[[ <font face="arial, helvetica" color="#cc0000">Spyce</font> ]]</big></b><br>
    </font>
</tr></table>

<hr>
<font face="arial, helvetica" size="-1">

<!-- body -->

<table width="100%" align=center><tr>
    <td align=left width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Prev:</b> None</font></td>
    <td align=center width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Up:</b> None</font></td>
    <td align=right width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Next:</b> None</font></td>
</tr></table>
<hr>
<big><a name="tag_new"></a><b>5.4. <font color=#ee0000>Writing Tag Libraries the hard way</font></b></big><p>


You can still write tag libraries manually if the tag declaration language doesn't
give you the tools you need. (About the only functionality it doesn't currently
expose is the looping ability used in spy:for.) You may wish to approximate
what you want with a <a href="doc-tag_new2.html">new-style tag library</a>
and examine the compiler's output (spyceCmd.py -c).
<p>
We begin with a basic example: <p>

<table border=1 align=center>
<tr><td align=left bgcolor="#cccccc">
  <font face="arial, helvetica" size="-1"><b>examples/myTaglib.py</b></font>
</td></tr><tr><td>
  <font face=courier>

    
<style>    
.STRING {
  color: #a0522d;
}
.COMMENT {
  color: #ff7448;
  font-family: serif;
}
.KEYWORD {
  color: #9e79af;
}
.FUNCTION {
  color: #0074ef;
}
</style>
<pre>
<span class="KEYWORD">from</span> <span class="NAME">spyceTag</span> <span class="KEYWORD">import</span> <span class="NAME">spyceTagLibrary</span><span class="OP">,</span> <span class="NAME">spyceTagPlus</span><span class="NEWLINE">
</span><span class="NL">
</span><span class="KEYWORD">class</span> <span class="FUNCTION">tag_foo</span><span class="OP">(</span><span class="NAME">spyceTagPlus</span><span class="OP">)</span><span class="OP">:</span><span class="NEWLINE">
</span><span class="INDENT">  </span><span class="NAME">name</span> <span class="OP">=</span> <span class="STRING">'foo'</span><span class="NEWLINE">
</span>  <span class="NAME">mustend</span> <span class="OP">=</span> <span class="NUMBER">1</span><span class="NEWLINE">
</span>  <span class="KEYWORD">def</span> <span class="FUNCTION">syntax</span><span class="OP">(</span><span class="NAME">self</span><span class="OP">)</span><span class="OP">:</span><span class="NEWLINE">
</span><span class="INDENT">    </span><span class="NAME">self</span><span class="OP">.</span><span class="NAME">syntaxPairOnly</span><span class="OP">(</span><span class="OP">)</span><span class="NEWLINE">
</span>    <span class="NAME">self</span><span class="OP">.</span><span class="NAME">syntaxNonEmpty</span><span class="OP">(</span><span class="STRING">'val'</span><span class="OP">)</span><span class="NEWLINE">
</span>  <span class="DEDENT"></span><span class="KEYWORD">def</span> <span class="FUNCTION">begin</span><span class="OP">(</span><span class="NAME">self</span><span class="OP">,</span> <span class="NAME">val</span><span class="OP">)</span><span class="OP">:</span><span class="NEWLINE">
</span><span class="INDENT">    </span><span class="NAME">self</span><span class="OP">.</span><span class="NAME">getOut</span><span class="OP">(</span><span class="OP">)</span><span class="OP">.</span><span class="NAME">write</span><span class="OP">(</span><span class="STRING">'&lt;font size="%s"&gt;&lt;b&gt;'</span> <span class="OP">%</span> <span class="NAME">str</span><span class="OP">(</span><span class="NAME">val</span><span class="OP">)</span><span class="OP">)</span><span class="NEWLINE">
</span>  <span class="DEDENT"></span><span class="KEYWORD">def</span> <span class="FUNCTION">end</span><span class="OP">(</span><span class="NAME">self</span><span class="OP">)</span><span class="OP">:</span><span class="NEWLINE">
</span><span class="INDENT">    </span><span class="NAME">self</span><span class="OP">.</span><span class="NAME">getOut</span><span class="OP">(</span><span class="OP">)</span><span class="OP">.</span><span class="NAME">write</span><span class="OP">(</span><span class="STRING">'&lt;/b&gt;&lt;/font&gt;&lt;br&gt;'</span><span class="OP">)</span><span class="NEWLINE">
</span><span class="NL">
</span><span class="DEDENT"></span><span class="DEDENT"></span><span class="KEYWORD">class</span> <span class="FUNCTION">myTaglib</span><span class="OP">(</span><span class="NAME">spyceTagLibrary</span><span class="OP">)</span><span class="OP">:</span><span class="NEWLINE">
</span><span class="INDENT">  </span><span class="NAME">tags</span> <span class="OP">=</span> <span class="OP">[</span><span class="NL">
</span>    <span class="NAME">tag_foo</span><span class="OP">,</span> <span class="NL">
</span>  <span class="OP">]</span><span class="NEWLINE">
</span><span class="NL">
</span><span class="DEDENT"></span><span class="ENDMARKER"></span>
</pre>
    
  </font>

</td></tr></table>
 <p>
Saving this code in <font face=courier>myTaglib.py</font>, in the same
directory as your script or anywhere else in the search path, one could then
use the <b>foo</b> active tag (defined above), as follows: <p>

<table border=1 align=center>
<tr><td align=left bgcolor="#cccccc">
  <font face="arial, helvetica" size="-1"><b>examples/tag.spy</b></font>
</td></tr><tr><td>
  <font face=courier>

    <pre><font color="#000000"><b><font color="#CC00CC">[[.taglib name=myTaglib as=me]]</font>
&lt;html&gt;&lt;body&gt;
&lt;spy:for var=x items=&quot;=range(2,6)&quot;&gt;
  &lt;me:foo val=&quot;=x&quot;&gt;size &lt;spy:print val=&quot;=x&quot; /&gt;&lt;/me:foo&gt;
&lt;/spy:for&gt;
&lt;/body&gt;&lt;/html&gt;
</b></font></pre>
  </font>

  </td></tr><tr><td align=right bgcolor="#cccccc">
    <font face="arial, helvetica" size="-1">
      
      <b><a href="examples/tag.spy">Run this code</a></b>
    </font>

</td></tr></table>
 <p>
An active tag library can be any Python class that derives from
<b>spyceTag.spyceTagLibrary</b>. The interesting aspects of this class
definition to implementors are: <p>
<ul>
<li><b>tags</b>: <br> This field is usually all that requires redefinition.
It should be a list of the <i>classes</i> (as opposed to instances) of the
active tags. </li> <p>
<li><b>start</b>(): <br> This methd is invoked by the engine upon loading
the library. The inherited method is a noop. </li> <p>
<li><b>finish</b>(): <br> This method is invoked by the engine upon
unloading the library after a request. The inherited method is a noop. </li>
<p>
</ul>
Each active tag can be any Python class that derives from
<b>spyceTag.spyceTag</b>. The interesting aspects of the class definition for
tag implementors are: <p>
<ul>
<li><b>name</b>: <br> This field MUST be overidden to indicate the name of
the tag that this class defines. </li> <p>
<li><b>buffer</b>: <br> This flag indicates whether the processing of the
body of the tag should be performed with the current output stream
(unbuffered) or with a new, buffered output stream. Buffering is useful for
tags that may want to transform, or otherwise use, the output of processing
their own bodies, before it is sent to the client. The inherited default is
false. </li> <p>
<li><b>conditional</b>: <br> This flag indicates whether this tag may
conditionally control the execution of its body. If true, then the begin()
method of the tag must return true to process the tag body, or false to skip
it. If the flag is set to false, then return value of the begin() method is
ignored, and the body executed (unless an exception is triggered). Some
tags, such as the <font face=courier>core:if</font> tag, require this
functionality, and will set the flag true. Many other kinds of tags do not,
thus saving a level of indentation (which is unfortunately limited in Python
-- hence the need for this switch). The inherited default is false. </li>
<p>
<li><b>loops</b>: <br> This flag indicates whether this tag may want to loop
over the execution of its body. If true, then the body() method of the tag
must return true to repeat the body processing, or false to move on to the
end() of the tag. If the flag is set to false, then the return value of the
body() method is ignored, and the body is not looped. Some tags, such as the
<font face="courier">core:for</font> tag, require this functionality, and
will set the flag true. Many other kinds of tags do not, thus saving a level
of indentation. The inherited default is false. </li> <p>
<li><b>catches</b>: <br> This flag indicates whether this tag may want to
catch any exceptions that occur during the execution of its body. If true,
then the catch() method of the tag will be invoked on exception. If the flag
is false, the exception will continue to propagate beyond this point. Some
tags, such as the <font face="courier">core:catch</font>, require this
functionality, and will set the flag true. Many other kinds of tags do not,
thus saving a level of indentation. The inherited default is false. </li>
<p>
<li><b>mustend</b>: <br> This flag indicates whether this tag wants the
end() method to get called, if the begin() completes successfully, <i>no
matter what</i>. In other words, the call to end() is placed in the finally
clause of
the try-finally block which begins just after the begin(). This is useful for
tag cleanup. However, many tags do not perform anything in the
end() of their tag, or perhaps perform operations that are not important in
the case of an exception. Such tags do not require this functionaliy, thus
saving a level of indentation. The inherited default is false. </li> <p>
<li><b>syntax</b>(): <br> This method is invoked at compile time to perform
any additional tag-specific syntax checks. The inherited method returns
None, which means that there are no syntax errors. If a syntax error is
detected, this function should return a string with a helpful message about
the problem. Alternatively, one could raise an
<b>spyceTagSyntaxException</b>. </li> <p>
<li><b>begin</b>( ... ): <br> This method is invoked when the corresponding
start tag is encountered in the document. All the attributes of the tag are
passed in by name. This method may return a boolean flag. If
<b>conditional</b> is set to true (see above), then this flag indicates
whether the body of the tag should be processed (true), or skipped (false).
The inherited method performs no operation, except to return true. </li> <p>
<li><b>body</b>( contents ): <br> This method is invoked when the body of
the tag has <i>completed</i> processing. It will be called also for a
singleton, which we assume simply has an empty body. However, it will not be
called if the begin() method has chosen to skip body processing entirely. If
the tag sets <b>buffer</b> to true for capturing the body processing output
(see above), then the string output of the body processing has been captured
and stored in <b>contents</b>. It is the responsibility of this method to
emit something, if necessary. If the tag does not buffer then
<b>contents</b> will be None, and any output has already been written to the
enclosing scope. If the <b>loops</b> flag is set to true, then this method
is expected to return a boolean flag. If the flag is true, then the body
will be processed again, followed by another invocation of this method. And
again, and again, until false is received. The inherited tag method performs
nothing and returns false. </li> <p>
<li><b>end</b>(): <br> This method is invoked when the corresponding end tag
is encountered. For a singleton tag, we assume that the end tag immediately
follows the begin, and still invoke this method. If the <b>mustend</b> flag
has been set to true, then the runtime engine semantics ensure that if the
begin method terminates successfully, this method <i>will</i> get called,
even in the case of an exception during body processing. The inherited
method is a noop. </li> <p>
<li><b>catch</b>( ex ): <br> If the <b>catches</b> flag has been set to
true, then if any exception occurs in the begin(), body() or end() methods
or from within the body processing, this method will be invoked. The
parameter <b>ex</b> holds the value that was thrown. The inherited method
simply re-raises the exception. </li> <p>
<li><b>getPrefix</b>(): <br> Return the prefix under which this tag library
was installed. </li> <p>
<li><b>getAttributes</b>(): <br> Return a dictionary of tag attributes.
</li> <p>
<li><b>getPaired</b>(): <br> Return true if this is a paired (open and
close) tag, or false if it is a singleton. </li> <p>
<li><b>getParent</b>( [name] ): <br> Return the object of the direct parent
tag, or None if this is the root active tag. Plain (inactive) tags do not
have objects associated with them in this hierarchy. If the optional
<b>name</b> parameter is provided, then we search up the tree for an active
tag of the same library and with the given name. If such a tag can not be
found, then return None. </li> <p>
<li><b>getOut</b>(): <br> Return the (possibly buffered) output stream that
this tag should write to. </li> <p>
<li><b>getBuffered</b>(): <br> Returns true if the tag output stream is a
local buffer, or false if the output is connected to the enlosing scope.
</li> <p>
</ul>
Note that Spyce goes to a lot of effort to avoid unnecessary indentation in
the code it generates for Active Tags.
A limitation of the Python runtime is that the level of indentation
within any method is limited by a
compile-time constant. You can change it, of course, but in most
Python distributions as of this writing (Feb 2005), this is currently set to 100.
See for instance
<a href="http://mail.python.org/pipermail/python-bugs-list/2003-June/018148.html">this thread</a>
from python-bugs.
<p>
For convenience, tag implementors may wish to derive their implementations
from <b>spyceTagPlus</b>, which provides some useful additional methods:
<ul>
<li><b>getModule</b>( name ): <br> Return a reference to a module
from the page context. The module is loaded, if necessary. </li> <p>
<li><b><s>syntaxExist</b>( [must]* )</s>: <br> Removed in 2.0;
Spyce now checks the signature of the begin method; arguments
with no default are enforced as required automatically. <p>
<li><b>syntaxNonEmpty</b>( [names]* ): <br> Ensure that if the attributes
listed in <b>names</b> exist, then each of them does not contain an empty
string value. Otherwise, a spyceTagSyntaxException is thrown. Note that the
actual existence of a tag is checked by syntaxExists(), and that this method
only checks that a tag is non-empty. Specifically, there is no exception
raised from this method, if the attribute does not exist. </li> <p>
<li><b>syntaxValidSet</b>( name, validSet ): <br> Ensure that the value of
the attribute <b>name</b>, if it exists, is one of the values in the set
<b>validSet</b>. Otherwise, a spyceTagSyntaxException is raised. </li> <p>
<li><b>syntaxPairOnly</b>(): <br> Ensure that this tag is a paired tag.
Otherwise, a spyceTagSyntaxException is thrown. </li> <p>
<li><b>syntaxSingleOnly</b>(): <br> Ensure that this tag is a singleton tag.
Otherwise, a spyceTagSyntaxException is thrown. </li> <p>
</ul>
Despite the length of this description, most tags are trivial to write, as
shown in the initial example. The easiest way to start is by having at a look
at various implemented tag libraries, such as <font
face=courier>tags/core.py</font>. The more curious reader is welcome to look
at the tag library internals in <font face=courier>spyceTag.py</font> and
<font face=courier>modules/taglib.py</font>. The tag semantics are ensured by
the Spyce compiler (see <font face=courier>spyceCompile.py</font>), though it
is likely easier simply to look at the generated Python code using the <font
face=courier>"spyce&nbsp;-c"</font> command-line facility. <p>
<hr>

<table width="100%" align=center><tr>
    <td align=left width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Prev:</b> None</font></td>
    <td align=center width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Up:</b> None</font></td>
    <td align=right width="33%" nowrap><font face="arial, helvetica" size="-1"><b>Next:</b> None</font></td>
</tr></table>
<!-- end body -->
<p>
</font>
</td></tr>
<tr><td colspan=5><hr></td></tr>
<tr><td colspan=5 height=15></td></tr>
<tr><td colspan=5>

  <table width="100%" border=0><tr>
    <td align=left valign=top>
      <font face="arial, helvetica" size="-1">
      <b><big>[[ <font face="arial, helvetica" color="#cc0000">Spyce</font> ]]</big></b><br>
      <small>Python Server Pages<br>version 2.0.3</small>
      </font>
    </td><td align=center valign=top>
      <a href="http://spyce.sourceforge.net"><img align=middle width=120 height=50 border=0 src="/spycepow.gif" alt="Spyce Powered"></a>
      <a href="http://sourceforge.net"><img align=middle src="http://sourceforge.net/sflogo.php?group_id=53655&amp;type=5" width="141" height="50" border="0" alt="SourceForge Logo"></a>
    </td><td align=right valign=top>
    </td>
  </tr></table>

</td></tr></table>

</body></html>
